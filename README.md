# ðŸŽ“ GET Card â€“ Apple Wallet

An Apple Wallet pass server for UCSC GET Card dining barcodes. Generates `.pkpass` files with live barcode and balance data, and automatically refreshes passes every 10 seconds via APNs push notifications.

> [!Warning]
> This project stores an irrovocable authentication session with GET on a server indefinitely. It will also send an extreme amount of push notifications to your iDevices which may result in additional battery drain. To get similar benifits without these caveats, please check out my [Siri Shortcut](https://www.icloud.com/shortcuts/004ac2ed06bb46b980c12740554c7657).

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Apple Wallet â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Cloudflare Worker   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚     Convex DB    â”‚
â”‚   (iOS)      â”‚  HTTPS  â”‚  (src/worker.js)     â”‚  HTTP   â”‚  (convex/*.js)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                            â”‚                               â”‚
       â”‚  APNs push (every 3s)      â”‚  GET API                     â”‚
       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                            â”‚   Convex cron â†’ pushNotifications.js
       â”‚                            â–¼
       â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚                  â”‚  Cbord GET API   â”‚
       â”‚                  â”‚  (barcodes/bal.) â”‚
       â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**How it works:**

1. A user visits the landing page, logs in via the UCSC GET portal, and pastes the resulting session URL.
2. The Worker extracts the session ID, auto-generates CBORD credentials (device ID + PIN), and returns a `.pkpass` file.
3. When the pass is added to Apple Wallet, iOS registers the device with the Cloudflare Worker (`POST /v1/devices/.../registrations/...`).
4. The Worker stores the device push token in Convex via authenticated HTTP calls.
5. A Convex cron job runs every **10 seconds**, sending empty APNs push notifications to all registered devices.
6. When iOS receives the push, it calls back to the Worker to fetch a fresh pass with up-to-date barcode and balance data from the GET API.

## Project Structure

```
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ worker.js          # Cloudflare Worker entry point & API routes
â”‚   â”œâ”€â”€ convexClient.js    # Authenticated HTTP client for Worker â†’ Convex
â”‚   â”œâ”€â”€ passGenerator.js   # .pkpass generation using passkit-generator
â”‚   â”œâ”€â”€ getClient.js       # Cbord GET Services API client
â”‚   â””â”€â”€ server.js          # Express server (alternative to Worker)
â”œâ”€â”€ convex/
â”‚   â”œâ”€â”€ _generated/        # Auto-generated by `npx convex dev` (gitignored)
â”‚   â”œâ”€â”€ schema.js          # Database schema (devices, passes, registrations)
â”‚   â”œâ”€â”€ registrations.js   # Internal mutations & queries for CRUD
â”‚   â”œâ”€â”€ http.js            # Authenticated HTTP router (Bearer token)
â”‚   â”œâ”€â”€ pushNotifications.js # APNs push notification action
â”‚   â””â”€â”€ crons.js           # 3-second cron job for push notifications
â”œâ”€â”€ models/
â”‚   â””â”€â”€ GetCard.pass/      # Pass template (pass.json, icons, logos)
â”œâ”€â”€ index.js               # Node.js/Express entry point (alternative)
â”œâ”€â”€ wrangler.jsonc          # Cloudflare Workers config
â””â”€â”€ package.json
```

## Prerequisites

- [Node.js](https://nodejs.org/) 18+
- [Wrangler CLI](https://developers.cloudflare.com/workers/wrangler/install-and-update/) for Cloudflare Workers
- A [Convex](https://convex.dev) account (free tier works)
- An [Apple Developer](https://developer.apple.com) account with:
  - A Pass Type ID (e.g., `pass.com.example.mypass`)
  - A pass signing certificate (`.p12` â†’ export as PEM)
  - Apple's WWDR intermediate certificate
  - An APNs authentication key (`.p8` file) for push notifications

## Setup

### 1. Install Dependencies

```bash
npm install
```

### 2. Set Up Convex

Create a new Convex project and link it to this repo:

```bash
npx convex dev
```

This will:

- Prompt you to log in to Convex (or create an account)
- Create a new project (or link to an existing one)
- Deploy the schema and functions from `convex/`
- Start watching for changes

Once deployed, note your **Convex deployment URL** â€” it will look like `https://your-project-123.convex.cloud`. Your **HTTP actions URL** will be `https://your-project-123.convex.site`.

### 3. Configure Convex Environment Variables

In the [Convex dashboard](https://dashboard.convex.dev), go to **Settings â†’ Environment Variables** and add:

| Variable           | Description                                                                   |
| ------------------ | ----------------------------------------------------------------------------- |
| `AUTH_TOKEN`       | A long random secret string (must match the Cloudflare Worker's `AUTH_TOKEN`) |
| `APNS_KEY_ID`      | 10-character Key ID from the Apple Developer portal                           |
| `APNS_TEAM_ID`     | Your Apple Developer Team ID                                                  |
| `APNS_PRIVATE_KEY` | Contents of your `.p8` APNs auth key file (use `\n` for newlines)             |
| `APNS_ENVIRONMENT` | `production` or `development` (defaults to `production`)                      |

### 4. Configure Cloudflare Worker Secrets

Set each secret using the Wrangler CLI:

```bash
wrangler secret put AUTH_TOKEN         # Same value as Convex AUTH_TOKEN
wrangler secret put CONVEX_SITE_URL    # e.g., https://your-project-123.convex.site
wrangler secret put SIGNER_CERT_PEM    # Pass signing certificate (PEM, with \n for newlines)
wrangler secret put SIGNER_KEY_PEM     # Pass signing private key (PEM, with \n for newlines)
wrangler secret put WWDR_PEM           # Apple WWDR certificate (PEM, with \n for newlines)
wrangler secret put PASS_PHRASE        # Passphrase for signerKey.pem (leave empty if none)
```

> **Note:** `WEB_SERVICE_URL` is optional. If omitted, it is auto-detected from the incoming request origin.

### 5. Deploy

#### Deploy Convex (backend)

```bash
npx convex deploy
```

This deploys the Convex functions, schema, cron jobs, and HTTP routes. The 3-second cron job will start running immediately after deployment.

#### Deploy Cloudflare Worker (frontend)

```bash
npm run deploy
```

This runs `wrangler deploy` and publishes the Worker to Cloudflare's edge network.

## Development

### Local Cloudflare Worker

```bash
npm run dev:workers
```

Starts a local Wrangler dev server at `http://localhost:8787`.

### Local Convex

```bash
npx convex dev
```

Starts the Convex dev server and watches for changes to `convex/` files. Functions are deployed automatically on save.

### Local Node.js/Express Server (alternative)

```bash
npm run dev
```

Starts the Express server with `--watch` for auto-reload. Requires a `.env` file (see `.env.example`).

## API Endpoints

### User-Facing

| Method | Path                          | Description                                            |
| ------ | ----------------------------- | ------------------------------------------------------ |
| `GET`  | `/`                           | Landing page â€” log in via UCSC and paste session URL   |
| `GET`  | `/pass?sessionId=<sessionId>` | Download a `.pkpass` file (auto-generates credentials) |

The `/pass` endpoint also accepts legacy `?id=<deviceId>&code=<pin>` query params as a fallback.

### Apple Wallet Web Service

These endpoints implement the [Apple Wallet Web Service protocol](https://developer.apple.com/documentation/walletpasses/adding-a-web-service-to-update-passes):

| Method   | Path                                                               | Auth        | Description                        |
| -------- | ------------------------------------------------------------------ | ----------- | ---------------------------------- |
| `POST`   | `/v1/devices/:deviceLibId/registrations/:passTypeId/:serialNumber` | `ApplePass` | Register device for push updates   |
| `GET`    | `/v1/devices/:deviceLibId/registrations/:passTypeId`               | None        | List updatable passes for a device |
| `GET`    | `/v1/passes/:passTypeId/:serialNumber`                             | `ApplePass` | Get latest version of a pass       |
| `DELETE` | `/v1/devices/:deviceLibId/registrations/:passTypeId/:serialNumber` | `ApplePass` | Unregister device                  |
| `POST`   | `/v1/log`                                                          | None        | Apple Wallet error log receiver    |

### Convex HTTP Actions (internal)

These are called by the Cloudflare Worker â€” not directly by clients. All require `Authorization: Bearer <AUTH_TOKEN>`.

| Method | Path                      | Description                                               |
| ------ | ------------------------- | --------------------------------------------------------- |
| `POST` | `/api/registerDevice`     | Store device + pass registration                          |
| `POST` | `/api/unregisterDevice`   | Remove a registration                                     |
| `GET`  | `/api/getPassesForDevice` | Query passes updated since timestamp                      |
| `POST` | `/api/touchPass`          | Mark a pass as updated                                    |
| `POST` | `/api/upsertPass`         | Create or update a pass record (auth token + CBORD creds) |
| `GET`  | `/api/getPassAuthToken`   | Look up the auth token for a specific pass                |
| `GET`  | `/api/getPassCredentials` | Look up stored CBORD credentials for a pass               |

## Convex Database Schema

### `devices`

| Field                     | Type     | Description                        |
| ------------------------- | -------- | ---------------------------------- |
| `deviceLibraryIdentifier` | `string` | Unique device ID from Apple Wallet |
| `pushToken`               | `string` | APNs push token for the device     |

### `passes`

| Field                 | Type                | Description                                 |
| --------------------- | ------------------- | ------------------------------------------- |
| `passTypeIdentifier`  | `string`            | e.g., `pass.com.mcrich.GetCard`             |
| `serialNumber`        | `string`            | Unique pass serial number                   |
| `authenticationToken` | `string`            | Per-pass random token for Apple Wallet auth |
| `lastUpdated`         | `number`            | Epoch ms timestamp of last update           |
| `cbordDeviceId`       | `string` (optional) | Stored CBORD device ID for auto-refresh     |
| `cbordPin`            | `string` (optional) | Stored CBORD PIN for auto-refresh           |

### `registrations`

| Field      | Type            | Description         |
| ---------- | --------------- | ------------------- |
| `deviceId` | `Id<"devices">` | Reference to device |
| `passId`   | `Id<"passes">`  | Reference to pass   |

## Security

- **All Convex functions are internal** â€” they cannot be called from the public Convex API. External access is gated through authenticated HTTP actions that validate a `Bearer <AUTH_TOKEN>` header.
- **AUTH_TOKEN** is a shared secret set in both Cloudflare Worker secrets and Convex environment variables. It authenticates Worker â†’ Convex communication.
- **Per-pass auth tokens** â€” each generated pass gets a unique random `authenticationToken` (via `crypto.randomUUID()`). Apple Wallet uses the `Authorization: ApplePass <token>` header on callbacks, and the Worker verifies it against the stored per-pass token in Convex.
- **CBORD credentials** (device ID + PIN) are auto-generated per pass and stored in Convex for automatic refresh â€” the user's UCSC password is never stored.
- **APNs credentials** (private key, key ID, team ID) are stored only in Convex environment variables â€” never in code.
- **Signing certificates** (PEM files) are stored as Cloudflare Worker secrets â€” never committed to the repository.

## Pass Auto-Update Flow

```
Every 10 seconds:
  1. Convex cron job fires
  2. pushNotifications.js queries all registered push tokens
  3. touchAllPasses() bumps lastUpdated on every pass
  4. Sends empty APNs push to each device via HTTP/2
  5. iOS receives push â†’ calls GET /v1/devices/.../registrations/...
  6. Worker queries Convex for passes updated since last check
  7. iOS calls GET /v1/passes/:passTypeId/:serialNumber for each
  8. Worker retrieves stored CBORD credentials from Convex
  9. Worker re-authenticates with GET API and fetches fresh barcode + balance
  10. Worker generates and returns a new .pkpass
  11. Apple Wallet updates the pass on the user's device
```

## Scripts

| Command             | Description                            |
| ------------------- | -------------------------------------- |
| `npm run dev`       | Start local Wrangler dev server        |
| `npm run deploy`    | Deploy Cloudflare Worker to production |
| `npm run tail`      | Tail Cloudflare Worker logs            |
| `npx convex dev`    | Start Convex dev server (watch mode)   |
| `npx convex deploy` | Deploy Convex functions to production  |
